# BSC 智能链



## 简介

- **目的**：作为币安链的补充，为以太坊应用和用户提供另一个交易成本更低、交易性能更好的生态空间，为 Defi 浪潮赋能（比如 ETH 对于 DEX 的兼容就很不好）
- **架构**
  - BSC 与 ETH：支持 EVM，兼容以太坊，可跨链
  - BSC 与 BC：两者都是币安 双公链计划中的实现，BSC 是与 BC平行的公链，BC 主要完成 Dex 去中心化交易，而 BSC 则主要承载智能合约、Dapp，为 BC 提供良好的性能，但这种平行的情况使得代币标准出现了两个（类似以太坊 ERC-20 和 ERC-？）、
  - 代币标准
    - BEP-2：BC 代币标准
    - BEP-20：BSC 代币标准 —— 本质上和 ERC-20 几乎兼容，多了部分接口

> 从以太坊到币安智能链 - 知乎 (zhihu.com) https://zhuanlan.zhihu.com/p/371064339 
>
> 究竟什么是币安链？币安智能链又是什么？ - 知乎 (zhihu.com) https://www.zhihu.com/question/412354775 
>
> 什么是币安智能链bsc - 知乎 (zhihu.com) https://www.zhihu.com/zvideo/1304353162199904256

### 官方资料

- **官网**：[Explore the Binance Smart Chain Ecosystem and Binance DEX. Fast, decentralized, affordable and secure.](https://www.binance.org/en)

- **官方文档与开发者文档**

  - [Introduction - Binance Chain Docs](https://docs.binance.org/smart-chain/guides/bsc-intro.html)
  - [Tools - Binance Chain Docs](https://docs.binance.org/smart-chain/developer/dev-tools.html)

- **geth 文档**

- - **geth** [Geth Documentation | Go Ethereum](https://geth.ethereum.org/docs/)

- - geth config [ethconfig package - github.com/ethereum/go-ethereum/eth/ethconfig - pkg.go.dev](https://pkg.go.dev/github.com/ethereum/go-ethereum/eth/ethconfig?utm_source=godoc#Config)

## 数据提取

### BSC 节点部署

#### **数据下载**

- **BSC snapshot 下载**

  - 官网已有打包好的 geth 客户端 levelDB 区块数据，直接在 BSC 文档的 fullnode 页面下载 snapshot 即可
  - 下载之后，将 snapshot 内容覆盖到 geth 部署的 data 文件夹中

- **geth（ethereum client ）下载**

  - 下载编译好的 geth 客户端
  - 下载客户端所需 config 文件
  - 写入创世区块

  ```shell
  # Linux
  wget  https://github.com/binance-chain/bsc/releases/download/v1.1.5/geth_linux
  
  ## mainet —— 这里代表主网配置文件
  wget https://github.com/binance-chain/bsc/releases/download/v1.1.5/mainnet.zip
  unzip mainnet.zip
  
  # Write genesis state locally
  geth --datadir node init genesis.json
  ```

#### **启动全节点**

- **启动指令**

  ```shell
  ## start a full node
  geth --config ./config.toml --datadir ./node  --cache 8000 --rpc.allow-unprotected-txs --txlookuplimit 0
  ```

  - config.toml 即配置文件（上面下载 geth 时下载的主网配置文件）
  - datadir 即区块数据文件夹

- **全节点配置**

  - **同步数据——fast 快速模式**

    - 默认使用该模式，先获取所有区块的 header，再不断填入区块体和 receipts，当获取所有 header 时，就进入 full 模式

  - **同步数据——full 模式**

    - 从创世区块同步所有链上交易数据

  - **同步数据——archive 归档模式**

    - 需要同步所有区块的状态，在后续可通过 RPC trace 内部交易

      ```
      # 启动参数中加上：
      --syncmode full --gcmode archive
      ```

  - **仅需要提取数据**

    - 应用在有全节点的 snapshot 只是需要提取数据而不需同步数据时
    - config 中 noDiscovery 设置为 true，即不会主动寻找节点来同步数据

- **启动问题**

  -  <u>looking for peers 问题</u>

    - 一般是找不到同步数据的节点会出现

    - **解决**

      - <u>设置 BootstrapNodes 和 StaticNodes</u>

        - 其中 staticNodes 的设置可以放在：`<datadir>/geth/static-nodes.json`

        ```
        BootstrapNodes = ["enode://1cc4534b14cfe351ab740a1418ab944a234ca2f702915eadb7e558a02010cb7c5a8c295a3b56bcefa7701c07752acd5539cb13df2aab8ae2d98934d712611443@52.71.43.172:30311","enode://28b1d16562dac280dacaaf45d54516b85bc6c994252a9825c5cc4e080d3e53446d05f63ba495ea7d44d6c316b54cd92b245c5c328c37da24605c4a93a0d099c4@34.246.65.14:30311","enode://5a7b996048d1b0a07683a949662c87c09b55247ce774aeee10bb886892e586e3c604564393292e38ef43c023ee9981e1f8b335766ec4f0f256e57f8640b079d5@35.73.137.11:30311"]
        
        StaticNodes = ["enode://f3cfd69f2808ef64838abd8786342c0b22fdd28268703c8d6812e26e109f9a7cb2b37bd49724ebb46c2332
        89f22da82991c87345eb9a2dadeddb8f37eeb259ac@18.180.28.21:30311","enode://ae74385270d4afeb953561603fcedc4a0e755a241ffdea31c3f751dc8be5bf29c03bf46e3051d1c8d997c45479a92632020c9a84b96dcb63b2259ec09b4fde38@54.178.30.104:30311","enode://d1cabe083d5fc1da9b510889188f06dab891935294e4569df759fc2c4d684b3b4982051b84a9a078512202ad947f9240adc5b6abea5320fb9a736d2f6751c52e@54.238.28.14:30311","enode://f420209bac5324326c116d38d83edfa2256c4101a27cd3e7f9b8287dc8526900f4137e915df6806986b28bc79b1e66679b544a1c515a95ede86f4d809bd65dab@54.178.62.117:30311","enode://c0e8d1abd27c3c13ca879e16f34c12ffee936a7e5d7b7fb6f1af5cc75c6fad704e5667c7bbf7826fcb200d22b9bf86395271b0f76c21e63ad9a388ed548d4c90@54.65.247.12:30311","enode://f1b49b1cf536e36f9a56730f7a0ece899e5efb344eec2fdca3a335465bc4f619b98121f4a5032a1218fa8b69a5488d1ec48afe2abda073280beec296b104db31@13.114.199.41:30311","enode://4924583cfb262b6e333969c86eab8da009b3f7d165cc9ad326914f576c575741e71dc6e64a830e833c25e8c45b906364e58e70cdf043651fd583082ea7db5e3b@18.180.17.171:30311","enode://4d041250eb4f05ab55af184a01aed1a71d241a94a03a5b86f4e32659e1ab1e144be919890682d4afb5e7afd837146ce584d61a38837553d95a7de1f28ea4513a@54.178.99.222:30311","enode://b5772a14fdaeebf4c1924e73c923bdf11c35240a6da7b9e5ec0e6cbb95e78327690b90e8ab0ea5270debc8834454b98eca34cc2a19817f5972498648a6959a3a@54.170.158.102:30311","enode://f329176b187cec87b327f82e78b6ece3102a0f7c89b92a5312e1674062c6e89f785f55fb1b167e369d71c66b0548994c6035c6d85849eccb434d4d9e0c489cdd@34.253.94.130:30311","enode://cbfd1219940d4e312ad94108e7fa3bc34c4c22081d6f334a2e7b36bb28928b56879924cf0353ad85fa5b2f3d5033bbe8ad5371feae9c2088214184be301ed658@54.75.11.3:30311","enode://c64b0a0c619c03c220ea0d7cac754931f967665f9e148b92d2e46761ad9180f5eb5aaef48dfc230d8db8f8c16d2265a3d5407b06bedcd5f0f5a22c2f51c2e69f@54.216.208.163:30311","enode://352a361a9240d4d23bb6fab19cc6dc5a5fc6921abf19de65afe13f1802780aecd67c8c09d8c89043ff86947f171d98ab06906ef616d58e718067e02abea0dda9@79.125.105.65:30311","enode://bb683ef5d03db7d945d6f84b88e5b98920b70aecc22abed8c00d6db621f784e4280e5813d12694c7a091543064456ad9789980766f3f1feb38906cf7255c33d6@54.195.127.237:30311","enode://11dc6fea50630b68a9289055d6b0fb0e22fb5048a3f4e4efd741a7ab09dd79e78d383efc052089e516f0a0f3eacdd5d3ffbe5279b36ecc42ad7cd1f2767fdbdb@46.137.182.25:30311","enode://21530e423b42aed17d7eef67882ebb23357db4f8b10c94d4c71191f52955d97dc13eec03cfeff0fe3a1c89c955e81a6970c09689d21ecbec2142b26b7e759c45@54.216.119.18:30311","enode://d61a31410c365e7fcd50e24d56a77d2d9741d4a57b295cc5070189ad90d0ec749d113b4b0432c6d795eb36597efce88d12ca45e645ec51b3a2144e1c1c41b66a@34.204.129.242:30311","enode://bb91215b1d77c892897048dd58f709f02aacb5355aa8f50f00b67c879c3dffd7eef5b5a152ac46cdfb255295bec4d06701a8032456703c6b604a4686d388ea8f@75.101.197.198:30311","enode://786acbdf5a3cf91b99047a0fd8305e11e54d96ea3a72b1527050d3d6f8c9fc0278ff9ef56f3e56b3b70a283d97c309065506ea2fc3eb9b62477fd014a3ec1a96@107.23.90.162:30311","enode://4653bc7c235c3480968e5e81d91123bc67626f35c207ae4acab89347db675a627784c5982431300c02f547a7d33558718f7795e848d547a327abb111eac73636@54.144.170.236:30311","enode://c6ffd994c4ef130f90f8ee2fc08c1b0f02a6e9b12152092bf5a03dd7af9fd33597d4b2e2000a271cc0648d5e55242aeadd6d5061bb2e596372655ba0722cc704@54.147.151.108:30311","enode://99b07e9dc5f204263b87243146743399b2bd60c98f68d1239a3461d09087e6c417e40f1106fa606ccf54159feabdddb4e7f367559b349a6511e66e525de4906e@54.81.225.170:30311","enode://1479af5ea7bda822e8747d0b967309bced22cad5083b93bc6f4e1d7da7be067cd8495dc4c5a71579f2da8d9068f0c43ad6933d2b335a545b4ae49a846122b261@52.7.247.132:30311"]
        
        ```

      - <u>config 中 noDiscovery 设置为 false</u>

  - <u>进程被杀问题</u>

    - 杀进程原因：geth 由于占用内存较大，总会在一段时间内被杀掉

    - <u>调整cache</u>

      - 可以在启动时先增大 swap、增大 data、triecache

      ```
      参数：
      --cache database
      --cache trie
      上两者和在 config 中的设置是不同的！如果在 config 中设置可能有512，而上者为 50
      ```

      

      - 调整之后，geth 虽然还会被杀后台，但存活时间变长了一些，可以勉强导出部分数据

    - <u>全节点自重启 —— 自制方案</u>

      - 可使用 ethereum-etl 工程中 sh/keep_eth.sh 配合 linux 的 crontab 来定时启动 geth 节点

  - <u>无法 trace 内部交易问题</u>

    - 需要以 --syncmode full --gcmode archive 启动，同步所有历史状态，但尝试过暂无解，有人使用 parity

    > 可参考：
    >
    > [Historical state missing despite archive mode · Issue #18441 · ethereum/go-ethereum (github.com)](https://github.com/ethereum/go-ethereum/issues/18441)
    >
    > [Error in export_geth_traces · Issue #206 · blockchain-etl/ethereum-etl (github.com)](https://github.com/blockchain-etl/ethereum-etl/issues/206)
    >
    > [Geth archive node: required historical state unavailable (reexec=128) · Issue #1433 · blockscout/blockscout (github.com)](https://github.com/blockscout/blockscout/issues/1433)——据说默认是 128 个区块之后无法 trace？

> 可参考内容：
>
> —— bsc和geth 的部署问题 ——
>
> [(42条消息) BSC（币安智能链）主网链部署_J_Lee-CSDN博客_bsc币安智能链](https://blog.csdn.net/cljdsc/article/details/116460970)
>
> [(1条消息) geth命令被杀死，以太坊节点自动死掉（swap使用）_steve_ji的博客-CSDN博客](https://blog.csdn.net/Little_Ji/article/details/104124578)
>
> [(1条消息) 以太坊geth同步自动关闭问题分析_程序新视界-CSDN博客](https://blog.csdn.net/wo541075754/article/details/78745382)
>
> [(1条消息) 以太坊geth节点同步亲测经历_程序新视界-CSDN博客](https://blog.csdn.net/wo541075754/article/details/79247282) —— 有比较全的 geth 节点同步问题
>
> [以太坊开发遇到的部分问题 - x_smile - 博客园 (cnblogs.com)](https://www.cnblogs.com/xsmile/p/12586185.html) —— 挖矿问题
>
> Sutdy Log 2021-9-2
>
> —— 接口问题 ——
>
> [(1条消息) 端口访问被拒绝的解决方案_Data & Analysis-CSDN博客_端口访问被拒绝的解决方案](https://unclewang.blog.csdn.net/article/details/86501669?utm_medium=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~default-1.no_search_link&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~default-1.no_search_link)
>
> [通过geth Json-Rpc接口遇到的坑 | Jiangxin's Blog (victorjiangxin.github.io)](https://victorjiangxin.github.io/etheStudy/)
>
> [geth --rpcaddr - 慢行厚积 - 博客园 (cnblogs.com)](https://www.cnblogs.com/wanghui-garcia/p/10109306.html)

#### **节点交互**

- **交互方式**

  - HTTP：HTTP 请求直接使用，可直接用 postman 或 curl 构造请求来发送

    - 外部接口访问：默认是监听本地的 localhost 接口（即只监听 http 包的目的地址为该套接字的包），可通过 --rpcaddr 或配置中的 HTTPHost 改成实际 ip （如 192.168.199.111）

    - 配置本地地址

      ```
      HTTPHost = "192.168.199.111"
      ```

  - ws：websocket 方式

  - ipc：编程调用 API 接口时使用（如 ethereum-etl）

    ```
    以上 3种方式默认在 config 中是打开的，也可以在启动 geth 时手动添加参数打开
    ```

- **交互模式**

  - config 中的 HTTPModules 或 WSModules 等

  -  分别对应 geth 接口中的不同 API，默认是没有 debug 的，所以建议将 debug 加上

    ```
    HTTPModules = ["eth", "net", "web3", "txpool", "parlia","debug"]
    WSModules = ["net", "web3", "eth","debug"]
    ```

  - 测试案例

    ```
    # 查看节点区块数据同步进度
    curl -s -H Content-Type:application/json -X POST --data '{"jsonrpc":"2.0","method":"eth_syncing","params":[],"id":1}' http://127.0.0.1:8545
    {"jsonrpc":"2.0","id":1,"result":false}
    
    # 查看节点最新区块号
    # curl -s -H Content-Type:application/json -X POST --data '{"jsonrpc":"2.0","method":"eth_blockNumber","params":[],"id":1}' http://127.0.0.1:8545
    
    ```

    

> geth 默认可通过 rpc 接口与节点进行交互，bsc 拥有 geth 相同的接口，也有自己独特的接口
>
> BSC接口：[Ethereum JSON-RPC (getpostman.com)](https://documenter.getpostman.com/view/4117254/ethereum-json-rpc/RVu7CT5J?version=latest#76d28171-796d-2551-47a0-7f33c325d300)
>
> geth 默认接口：[JSON-RPC Server | Go Ethereum](https://geth.ethereum.org/docs/rpc/server)



### Ethereum ETL

#### 简介

- 基于 python 的区块链提取器，可

#### 操作

- ethereum-etl 提取流程：

- - export_blocks_and_transactions 提取区块与交易数据
  - export_receipts_and_logs 提取交易详情与 log
  - export_contracts 提取合约地址
  - export_tokens 提取 token 地址

#### 改进

